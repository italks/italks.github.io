# è·¯ç”±ç³»ç»Ÿæ·±æ½œï¼šåŠ¨æ€æƒé™ã€æ–‡ä»¶è·¯ç”±ä¸å¾®å‰ç«¯ (Vue 3 Mastery Series - 07)

## å¼•è¨€ï¼šè·¯ç”±çš„æ¼”è¿›

åœ¨å‰ç«¯å•é¡µåº”ç”¨ï¼ˆSPAï¼‰çš„æ—©æœŸï¼Œæˆ‘ä»¬ä¹ æƒ¯æ‰‹åŠ¨ç¼–å†™è·¯ç”±è¡¨ï¼ˆ`routes` æ•°ç»„ï¼‰ã€‚éšç€é¡¹ç›®è§„æ¨¡çš„æ‰©å¤§ï¼Œè¿™ä¸ªæ–‡ä»¶å¾€å¾€å˜å¾—éš¾ä»¥ç»´æŠ¤ï¼š
*   **æƒé™æ§åˆ¶**ï¼šå“ªäº›é¡µé¢éœ€è¦ç™»å½•ï¼Ÿå“ªäº›éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Ÿ
*   **æ‡’åŠ è½½**ï¼šæ¯ä¸ªè·¯ç”±éƒ½è¦å†™ `import()`ï¼Œå®¹æ˜“å¿˜è®°ã€‚
*   **åµŒå¥—å±‚çº§**ï¼šä¸ºäº†é…åˆå¸ƒå±€ï¼ŒåµŒå¥—è·¯ç”±å†™å¾—å¤´çš®å‘éº»ã€‚

Vue Router 4 å¸¦æ¥äº†æ›´çµæ´»çš„ APIï¼Œè€Œç¤¾åŒºæ›´æ˜¯æ¶Œç°å‡ºäº†åƒ `unplugin-vue-router` è¿™æ ·çš„ç¥å™¨ï¼Œè®©è·¯ç”±ç®¡ç†å˜å¾—å‰æ‰€æœªæœ‰çš„ç®€å•ã€‚

## 1. Vue Router 4 è¿›é˜¶ï¼šåŠ¨æ€è·¯ç”±ä¸æƒé™

åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²åŠ¨æ€ç”Ÿæˆèœå•å’Œè·¯ç”±æ˜¯åˆšéœ€ã€‚

### 1.1 åŠ¨æ€æ·»åŠ è·¯ç”± (addRoute)

å‡è®¾æˆ‘ä»¬ä»åç«¯è·å–äº†ä¸€ä»½èœå•æ•°æ®ï¼Œå¦‚ä½•æŠŠå®ƒè½¬æ¢æˆè·¯ç”±ï¼Ÿ

```javascript
// router/permission.js
import router from '@/router'
import { useUserStore } from '@/stores/user'

const modules = import.meta.glob('../views/**/*.vue')

export function generateRoutes(menuList) {
  const routes = []
  
  menuList.forEach(item => {
    const route = {
      path: item.path,
      name: item.name,
      component: modules[`../views/${item.component}.vue`], // åŠ¨æ€å¯¼å…¥ç»„ä»¶
      meta: { title: item.title, roles: item.roles }
    }
    
    // åŠ¨æ€æ·»åŠ åˆ° router å®ä¾‹
    router.addRoute('layout', route) // æ·»åŠ åˆ°åä¸º 'layout' çš„çˆ¶è·¯ç”±ä¸‹
    routes.push(route)
  })
  
  return routes
}
```

æ³¨æ„ `import.meta.glob` æ˜¯ Vite çš„ç‰¹æ€§ï¼Œå®ƒå…è®¸ä½ åŠ¨æ€å¯¼å…¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚

### 1.2 å¯¼èˆªå®ˆå« (Navigation Guards)

é™¤äº†å…¨å±€å®ˆå« `beforeEach`ï¼ŒVue Router 4 è¿˜æ”¯æŒåœ¨ç»„ä»¶å†…å®šä¹‰å®ˆå«ï¼Œé…åˆ Composition API ä½¿ç”¨éå¸¸æ–¹ä¾¿ã€‚

```vue
<script setup>
import { onBeforeRouteLeave, onBeforeRouteUpdate } from 'vue-router'

// ç¦»å¼€å½“å‰è·¯ç”±å‰ï¼ˆä¾‹å¦‚è¡¨å•æœªä¿å­˜ï¼‰
onBeforeRouteLeave((to, from) => {
  if (isDirty.value) {
    const answer = window.confirm('ä½ æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ')
    if (!answer) return false // å–æ¶ˆå¯¼èˆª
  }
})

// è·¯ç”±å‚æ•°å˜åŒ–ä½†ç»„ä»¶å¤ç”¨æ—¶ï¼ˆä¾‹å¦‚ /user/1 -> /user/2ï¼‰
onBeforeRouteUpdate((to, from) => {
  userId.value = to.params.id
  fetchUser(userId.value)
})
</script>
```

## 2. æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ï¼šåƒ Nuxt ä¸€æ ·å¼€å‘

æ‰‹åŠ¨ç»´æŠ¤ `routes` æ•°ç»„å¤ªç´¯äº†ã€‚ä¸ºä»€ä¹ˆä¸èƒ½åƒ Nuxt æˆ– Next.js ä¸€æ ·ï¼Œæ ¹æ® `pages` ç›®å½•ä¸‹çš„æ–‡ä»¶ç»“æ„è‡ªåŠ¨ç”Ÿæˆè·¯ç”±å‘¢ï¼Ÿ

**unplugin-vue-router** å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿçš„ã€‚

### 2.1 å®‰è£…ä¸é…ç½®

```bash
npm i -D unplugin-vue-router
```

åœ¨ `vite.config.js` ä¸­é…ç½®ï¼š

```javascript
import VueRouter from 'unplugin-vue-router/vite'

export default defineConfig({
  plugins: [
    VueRouter({ /* options */ }),
    Vue()
  ]
})
```

### 2.2 ç›®å½•ç»“æ„å³è·¯ç”±

ç°åœ¨ï¼Œä½ åªéœ€è¦åœ¨ `src/pages` ä¸‹åˆ›å»ºæ–‡ä»¶ï¼š

*   `src/pages/index.vue` -> `/`
*   `src/pages/about.vue` -> `/about`
*   `src/pages/users/[id].vue` -> `/users/:id`
*   `src/pages/users/[id]/edit.vue` -> `/users/:id/edit`

å®Œå…¨ä¸éœ€è¦æ‰‹å†™è·¯ç”±é…ç½®ï¼è€Œä¸”å®ƒè¿˜æ”¯æŒ **TypeScript ç±»å‹è‡ªåŠ¨ç”Ÿæˆ**ã€‚å½“ä½ å†™ `<RouterLink to="...">` æ—¶ï¼ŒIDE ä¼šæ™ºèƒ½æç¤ºæ‰€æœ‰å¯ç”¨çš„è·¯å¾„ï¼Œå¹¶åœ¨ä½ å†™é”™æ—¶æŠ¥é”™ã€‚

### 2.3 æ‰©å±•è·¯ç”±å…ƒä¿¡æ¯

å¦‚æœæƒ³ç»™æŸä¸ªé¡µé¢æ·»åŠ  `meta` ä¿¡æ¯ï¼ˆå¦‚æ ‡é¢˜ã€æƒé™ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `<route>` å—ï¼š

```vue
<route lang="json">
{
  "meta": {
    "layout": "admin",
    "requiresAuth": true
  }
}
</route>

<template>
  <div>Admin Page</div>
</template>
```

## 3. Data Loadersï¼šè·¯ç”±ä¸æ•°æ®è·å–çš„å®Œç¾ç»“åˆ

Vue Router ç”Ÿæ€æ­£åœ¨æ¢ç´¢ä¸€ä¸ªæ–°çš„æ–¹å‘ï¼š**Data Loaders**ã€‚å®ƒæ—¨åœ¨è§£å†³â€œå¯¼èˆªå®Œæˆåæ‰å¼€å§‹è¯·æ±‚æ•°æ®å¯¼è‡´é¡µé¢ç©ºç™½â€çš„é—®é¢˜ï¼Œé€šå¸¸éœ€è¦æ­é…ç›¸å…³æ’ä»¶ç”Ÿæ€ä¸€èµ·ä½¿ç”¨ã€‚

ä¼ ç»Ÿçš„åšæ³•æ˜¯åœ¨ç»„ä»¶çš„ `onMounted` é‡Œè¯·æ±‚æ•°æ®ã€‚è€Œ Data Loaders å…è®¸ä½ åœ¨**å¯¼èˆªå‘ç”Ÿä¹‹å‰**ï¼ˆæˆ–å¹¶è¡Œï¼‰è¯·æ±‚æ•°æ®ã€‚

```javascript
export const useUserData = defineLoader(async (route) => {
  return await fetchUser(route.params.id)
})
```

åœ¨ç»„ä»¶ä¸­ï¼š

```vue
<script setup>
const user = useUserData() // æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼
</script>
```

è¿™ä¸ä»…æ¶ˆé™¤äº†â€œLoading...â€é—ªçƒï¼Œè¿˜è®©ç»„ä»¶é€»è¾‘æ›´åŠ çº¯ç²¹ã€‚

## 4. æ€»ç»“

è·¯ç”±ç³»ç»Ÿæ˜¯å‰ç«¯æ¶æ„çš„æ ¸å¿ƒéª¨æ¶ã€‚ä»æ‰‹åŠ¨é…ç½®åˆ°è‡ªåŠ¨ç”Ÿæˆï¼Œä»ç®€å•çš„è·³è½¬åˆ°å¤æ‚çš„æƒé™æ§åˆ¶ï¼ŒVue Router 4 æä¾›äº†å¼ºå¤§çš„èƒ½åŠ›ã€‚

*   **åŠ¨æ€è·¯ç”±**ï¼šé…åˆåç«¯èœå•æ•°æ®ï¼Œå®ç°çµæ´»çš„æƒé™ç®¡ç†ã€‚
*   **æ–‡ä»¶è·¯ç”±**ï¼šä½¿ç”¨ `unplugin-vue-router` æå‡å¼€å‘æ•ˆç‡å’Œç±»å‹å®‰å…¨ã€‚
*   **Data Loaders**ï¼šæ¢ç´¢æœªæ¥çš„æ•°æ®è·å–æ¨¡å¼ã€‚

**ä¸‹ä¸€ç¯‡é¢„å‘Š**ï¼š
å¼€å‘ç¯å¢ƒé…ç½®å¥½äº†ï¼Œä»£ç ä¹Ÿå†™å¾—å·®ä¸å¤šäº†ï¼Œå¦‚ä½•ä¿è¯æ‰“åŒ…å‡ºæ¥çš„åº”ç”¨ä½“ç§¯å°ã€åŠ è½½å¿«ï¼ŸVite çš„æ„å»ºä¼˜åŒ–æœ‰å“ªäº›é»‘ç§‘æŠ€ï¼Ÿå¦‚ä½•ç¼–å†™ä¸€ä¸ª Vite æ’ä»¶ï¼Ÿä¸‹ä¸€ç¯‡ã€ŠVite æé€Ÿæ„å»ºã€‹å°†ä¸ºä½ æ­ç§˜ã€‚

---

> **è¿™é‡Œæ˜¯ã€ŠVue 3 å…¨æ™¯æ”»ç•¥ã€‹ç³»åˆ—æ•™ç¨‹ã€‚**
>
> å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ **ç‚¹èµã€åœ¨çœ‹ã€åˆ†äº«** æ”¯æŒä¸€ä¸‹ï¼
>
> ğŸ‘‡ **å…³æ³¨å…¬ä¼—å·ã€Œç§»åŠ¨APPå¼€å‘ã€ï¼Œå›å¤â€œVue3â€è·å–æœ¬ç³»åˆ—å®Œæ•´æ€ç»´å¯¼å›¾ä¸æºç ã€‚**

*(æ­¤å¤„æ’å…¥å…¬ä¼—å·åç‰‡)*
